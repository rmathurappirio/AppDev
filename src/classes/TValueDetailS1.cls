public class TValueDetailS1 {

    private ApexPages.StandardController controller;
    private TValueDocument__c tvalueObj;
    private  String initReferer;

    public TValueDetailS1(ApexPages.StandardController stdController) {
        tvalueObj = null;
        initReferer = ApexPages.currentPage().getHeaders().get('Referer');
        controller=stdController;
    }

 public PageReference save() {
        controller.save();
        return null;
  }
  
  public PageReference done() {
        controller.save();
        PageReference done = new PageReference('/'+tvalueObj.Opportunity__c);   
        done.setRedirect(true);
        return done;
  }
  
   public PageReference deletes() {
        controller.delete();
        PageReference done = new PageReference('/'+tvalueObj.Opportunity__c);   
        done.setRedirect(true);
        return done;
  }
  
   public PageReference saveclone() {
        controller.save();
        PageReference cloner = new PageReference('/apex/TValueClonePage?id='+tvalueObj.id);   
        cloner.setRedirect(true);
        return cloner;
  }


    public String getInitialReferer() {
        return initReferer;
    }
    

    @RemoteAction
    public static Boolean remoteSave(ID tvId, String tvalueStr) {
        TValueDocumentFields fields = new TValueDocumentFields();
        Boolean success = false;
        Attachment attachObj;

        TValueDocument__c tvObj = fields.selectAllQuery(tvId);
        if (tvObj != null) {
            fields.parseTVDoc(tvalueStr);
            if (fields.saveFieldValues(tvObj)) {
                update tvObj;
                success = true;
            }
        }

        if (success) {
            try {
                attachObj = [select id, parentId, name, body from Attachment where parentId = :tvId];
            }
            catch (Exception e) {
                attachObj = null;
            }

            if (attachObj == null) {
                attachObj = new Attachment(
                    ParentId = tvId,
                    Name = 'TValueAutoGenerated',
                    Body = Blob.valueOf(tvalueStr)
                );
                insert attachObj;
            }
            else {
                attachObj.body = Blob.valueOf(tvalueStr);
                update attachObj;
            }
        }
        return success;
    }


    @RemoteAction
    public static String remoteRead(ID tvId) {
        String tvalueStr = '';
        Attachment attachObj;

        try {
            attachObj = [select id, parentId, name, body from Attachment where parentId = :tvId];
        }
        catch (Exception e) {
            attachObj = null;
        }
        if (attachObj != null) {
            tvalueStr = attachObj.body.toString();
        }

        return tvalueStr;
    }


    @RemoteAction
    public static String remoteTValueCallout(String bodyContent){
         String responseString = '';
         HTTPResponse res;
     
         HttpRequest req = new HttpRequest();
         req.setEndpoint('https://www.TValueOnline.com/SalesForce/SalesForceAjaxPage.aspx');
         req.setMethod('POST');
         req.setBody(bodyContent);
   
         // Create a new http object to send the request object
         // A response object is generated as a result of the request  
         try {
             Http http = new Http();
             res = http.send(req);
             responseString = res.getBody();
         } 
         catch(System.CalloutException e) { 
            System.debug('STATUS:'+res.getStatus());     
            System.debug('STATUS_CODE:'+res.getStatusCode());
         }

         return responseString;
    }


    public String getName() {
        return 'TValueDetailS1';
    }
    
    public TValueDocument__c getTValueDocument() {
        if(tvalueObj == null) {
            tvalueObj = [select id, name, rate__c, opportunity__r.id, IncludeProposal__c from TValueDocument__c where id = :ApexPages.currentPage().getParameters().get('id')];
        }
        return tvalueObj;
    }
   
}